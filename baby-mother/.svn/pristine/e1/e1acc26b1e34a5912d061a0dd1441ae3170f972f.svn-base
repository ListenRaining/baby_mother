var app = getApp()

Page({

    data: {
        textareaShowFlag:true,
        delId:null,
        delType:null,
        pCommentBtnColor:'#fff',
        pCommentBtnFontColor:'#bdbdbd',
        key:null,    //点赞时首页变化
        actionSheetData:{
            commentActionSheetFlag: false,
            itemList:[
                {
                    msg:"删除"
                }
            ]
        },

        rootRelativePath: '../../../',
        info:[],
        uid:0,
        comment_num:0,  //评论数

        baseurl:app.globalData.baseUrl,
        needShowDelBtn:false,
        placedeDefault:"输入评论内容",
        placeText:"输入评论内容",
        admireCnt: 13,
        isAdmire: false,
        animation:null,
        focus:false,
        value:"",
        commentIndexTB:{
            findex:null,
            cindex:null,
        }
    },

    /**
     * 生命周期函数--监听页面加载
     */
    onLoad: function (options) {

        //邀请人id入缓存
        if (options.puid) {
            wx.setStorage({
                key: 'puid',
                data: options.puid,
            })
        }

        //判断key参数(是否点赞)
        if (options.key) {
            this.setData({
                key:options.key
            })
        }

        this.setData({
            id:options.id
        })

        var that = this;
        // 调用缓存用户信息
        wx.getStorage({
            key: 'userinfo',
            success: function (res) {
                that.setData({
                    uid:res.data.uid
                })
            }
        })

        that.getContent(options.id);
    },

    getContent: function (id){
        var that= this;
        wx.request({
            url: app.globalData.baseUrl + 'little/operate/getContentDetail',
            data: {
                id: id,
                uid: that.data.uid
            },
            success: function (res) {
                wx.setNavigationBarTitle({
                    title: res.data.info.user.username+'的分享'//页面标题为路由参数
                })
                if (that.data.uid == res.data.info.uid) {
                    that.setData({
                        needShowDelBtn: true
                    });
                } else {
                    that.setData({
                        needShowDelBtn: false
                    });
                }

                that.setData({
                    info: res.data.info
                })
            },
        })
    },

    viewLocation:function(_e){
        var query = wx.createSelectorQuery()
        query.select('.comment').boundingClientRect()
        query.exec(function (res) {
            wx.pageScrollTo({
                scrollTop: res[0].top
            })
        })
    },

    clickCancel:function(){
        this.setData({
            'actionSheetData.commentActionSheetFlag':false,
            textareaShowFlag:true,
            delId:null,
            delType:null
        });
    },

    clickAct:function(_e){
        var index=  _e.currentTarget.dataset.index;
        var item = this.data.actionSheetData.itemList[index];
        if (item.msg == '删除')
        {
            var that= this;
            wx.request({
                url: app.globalData.baseUrl + '/little/operate/del_comment',
                data: {
                    id: that.data.delId,
                    type: that.data.delType,
                    cid:that.data.id
                },
                success: function (res) {
                    if (res.data.result == 'succ') {
                        that.getContent(that.data.info.id);
                        that.clearFocusData();
                        that.setData({
                            'actionSheetData.commentActionSheetFlag': false,
                            textareaShowFlag: true,
                            delId: null,
                            delType:null,
                        });
                    } else {
                        wx.showToast({
                            title: res.data.reason
                        })
                    }
                }
            })
        }
    },

    clickComment:function(_e){
        var findex = _e.currentTarget.dataset.findex;
        var cindex = _e.currentTarget.dataset.cindex;
        var newCommentIndexTB = this.data.commentIndexTB;
        var comment = this.data.info.comment[findex];
        var contentTB = comment;
        var newDelType= 1;
        if (cindex != null) {
            contentTB = comment.reply[cindex];
            newDelType= 0;
        }

        if (this.data.uid == contentTB["comment_uid"])
        {
            this.setData({
                'actionSheetData.commentActionSheetFlag': true,
                textareaShowFlag:false,
                focus: false,
                delId: contentTB["id"],
                delType: newDelType
            });
            return false;
        }

        if (newCommentIndexTB.findex != findex || newCommentIndexTB.cindex != cindex)
        {
            this.setData({
                value: ""
            });
        }

        if (!this.data.focus)
        {
            this.setData({
                focus: true
            });
        }

        newCommentIndexTB.findex = findex;
        newCommentIndexTB.cindex = cindex;

        this.setData({
            placeText: '回复' + contentTB["comment_name"],
            commentIndexTB:newCommentIndexTB
        });
    },

    textInput:function(_e){
        var color = '#3db049'
        var fontcolor = '#fff'
        if (_e.detail.value == null || _e.detail.value.length == 0) {
            color= '#fff'
            fontcolor = '#bdbdbd'
        }
        this.setData({
            pCommentBtnColor: color,
            pCommentBtnFontColor: fontcolor
        });
    },

    bindTextAreaBlur:function(_e){
        this.setData({
            focus: false
        });
        if (_e.detail.value == null || _e.detail.value.length == 0)
        {
            this.clearFocusData();
        }
    },

    clearFocusData:function(){
        var newCommentIndexTB = this.data.commentIndexTB;
        newCommentIndexTB.findex = null;
        newCommentIndexTB.cindex = null;
        this.setData({
            placeText: this.data.placedeDefault,
            commentIndexTB: newCommentIndexTB,
            value: ""
        });
    },

    /**
    * 发表评论
    */
    publishComment:function(_e){
        var value = _e.detail.value;
        var commentConent = value.content;
        if (commentConent == null || commentConent.length == 0)
        {
            wx.showToast({
                title: '请输入完整信息',
            });
            return;
        }
        var tcid = this.data.info.id;
        var tcomment_id= null;
        var tcomment_uid = this.data.uid;
        var treply_uid= null;
        if (this.data.commentIndexTB.findex)
        {
            var comment = this.data.info.comment[this.data.commentIndexTB.findex];
            var contentTB = comment;
            tcomment_id = contentTB["id"];
            if (this.data.commentIndexTB.cindex != null) {
                contentTB = comment.reply[this.data.commentIndexTB.cindex];
                treply_uid = contentTB["comment_uid"];
                tcomment_id = contentTB["comment_id"];
            }
        }

        var that= this;
        wx.request({
            url: app.globalData.baseUrl + '/little/operate/comment',
            data: {
                cid: tcid,
                comment_id: tcomment_id,
                comment_uid: tcomment_uid,
                reply_uid: treply_uid,
                comment_user_uid: that.data.info.uid,
                content: commentConent,
            },
            success: function (res) {
                if (res.data.result == 'succ')
                {
                    that.getContent(tcid);
                    that.clearFocusData();
                    that.setData({
                        comment_num: res.data.count,
                        pCommentBtnColor: '#fff'
                    });

                    //更新首页评论数
                    if (that.data.key != null) {
                        wx.getStorage({
                            key: 'indexContent',
                            success: function(info) {
                                var list = info.data;
                                list[that.data.key]['comment_num'] = res.data.count;
                                wx.setStorage({
                                    key: 'indexContent',
                                    data: list,
                                })
                            },
                        })
                    }
                } else {
                    wx.showToast({
                      title: res.data.reason
                    })
                }
            }
        })
    },

    clickAdmireEffect: function () {
        var newAnimation = wx.createAnimation({
            duration: 1000,
            timingFunction: 'ease',
        })
        newAnimation.scale(3, 3).rotate(90).step();
        this.setData({
            //输出动画
            animation: newAnimation.export()
        })

        setTimeout(function () {
            newAnimation.scale(1, 1).rotate(0).step()
            this.setData({
                animation: newAnimation.export()
            })
        }.bind(this), 150)
    },

    //授权操作
    getuser:function (e) {

        //隐藏遮罩层
        this.setData({
            'display':'none'
        })

        if(e.detail.encryptedData){
            app.getUserInfoNew(e.detail.encryptedData,e.detail.iv,'/pages/find/UGC_details/UGC_details?id='+this.data.id+'&key='+this.data.key);
        }else{
            console.log('拒绝授权');
        }
    },

    clickAdmire: function (_e) {
        var that = this;
        if(that.data.uid == 0){
            that.setData({
                display:'block'
            })
            return false;
        }

        var index = _e.currentTarget.dataset.index;
        var newZanNum = this.data.info.zan_num;
        var newIsZan = !this.data.info.is_zan;

        newIsZan ? that.clickAdmireEffect(index) : null;
        newIsZan ? newZanNum++ : newZanNum--;
        var newInfo = that.data.info;
        newInfo.is_zan = newIsZan;
        newInfo.zan_num = newZanNum;
        that.setData({
            info: newInfo
        });

        //点赞，取消点赞首页的变化
        if (that.data.key != null) {
            wx.getStorage({
                key: 'indexContent',
                success: function (res) {
                    var list = res.data
                    list[that.data.key]['is_zan'] = newIsZan
                    list[that.data.key]['zan_num'] = newZanNum
                    wx.setStorage({
                        key: 'indexContent',
                        data: list,
                    })
                }
            })
        }
    },

    /**
    * 删除文章
    */
    delCallBack: function (e) {
        var id = e.currentTarget.id;
        wx.showModal({
            title: '确定要删除该文章吗',
            showCancel: true,
            success: function(result) {
                if(result.confirm) {
                    wx.request({
                        url: app.globalData.baseUrl + 'little/operate/delmycontent',
                        data: {
                            cid: id
                        },
                        success: function (res) {
                            if (res.data.result == 'succ') {
                                wx.setStorage({
                                    key: 'reload',
                                    data: 1,
                                })
                                wx.navigateBack({});
                            } else {
                                wx.showToast({
                                    title: res.data.reason
                                })
                            }
                        }
                    })
                }
            }
        })
    },

    /**
    * 转发页面
    */
    onShareAppMessage: function () {
        if(this.data.uid){
            return {
                title: this.data.info.title,
                path: '/pages/find/UGC_details/UGC_details?id='+this.data.info.id+'&puid='+this.data.uid
            }
        }else{
            return {
                title: this.data.info.title,
                path: '/pages/find/UGC_details/UGC_details?id='+this.data.info.id
            }
        }
    }
})